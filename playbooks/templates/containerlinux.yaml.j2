etcd:
  name: "{{ inventory_hostname }}"
  version: 3.3.12
  strict_reconfig_check: true

  advertise_client_urls: "https://{{ ansible_host }}:2379"
  initial_advertise_peer_urls: "https://{{ ansible_host }}:2380"
  initial_cluster: "{{ '%s=http://%s:2380' | format(inventory_hostname, ansible_host) }}"

  listen_client_urls: https://0.0.0.0:2379
  listen_peer_urls: https://0.0.0.0:2380
  listen_metrics_urls: http://0.0.0.0:2381

  cert_file: /etc/ssl/certs/etcd/https.crt
  key_file: /etc/ssl/certs/etcd/https.key

  client_cert_auth: true
  trusted_ca_file: /etc/ssl/certs/etcd/ca.crt

  peer_client_cert_auth: true
  peer_trusted_ca_file: /etc/ssl/certs/etcd/ca.crt
  peer_cert_file: /etc/ssl/certs/etcd/peer.crt
  peer_key_file: /etc/ssl/certs/etcd/peer.key

passwd:
  users:
  - name: core
    ssh_authorized_keys: {{ lookup('url', 'https://github.com/wmedlar.keys', wantlist=True) | to_json }}

  # etcd user must be created here to reference it by name in .storage.files
  - name: etcd
    no_create_home: true
    shell: /sbin/nologin

storage:
  disks:
  # this is the disk we install coreos to (the -d argument); this block has no effect, the partition table will already
  # be in the desired state when ignition is run, it is simply included for completeness
  - device: /dev/sda
    wipe_table: false

  - device: /dev/sdb
    wipe_table: true
    partitions:
    - label: STORAGE0
      type_guid: linux_filesystem_data

  - device: /dev/sdc
    wipe_table: true
    partitions:
    - label: STORAGE1
      type_guid: linux_filesystem_data

  filesystems:
  - name: root
    mount:
      device: /dev/disk/by-partlabel/ROOT
      format: ext4
      wipe_filesystem: false

  - name: storage0
    mount:
      device: /dev/disk/by-partlabel/STORAGE0
      format: ext4
      wipe_filesystem: false

  - name: storage1
    mount:
      device: /dev/disk/by-partlabel/STORAGE1
      format: ext4
      wipe_filesystem: false

  files:
  - filesystem: root
    path: /etc/hostname
    contents:
      inline: "{{ inventory_hostname }}"

  - filesystem: root
    path: /etc/ssl/certs/etcd/ca.crt
    contents:
      local: etcd.crt

{% for item in ["https", "peer"] %}
  - filesystem: root
    path: /etc/ssl/certs/etcd/{{ item }}.crt
    contents:
      local: etcd-{{ item }}.crt

  - filesystem: root
    path: /etc/ssl/certs/etcd/{{ item }}.key
    contents:
      local: etcd-{{ item }}.key
    mode: 0400
    user:
      name: etcd

{% endfor %}

systemd:
  units:
  - name: docker.service
    enabled: true

  - name: mnt-storage0.mount
    enabled: true
    contents: |
      [Unit]
      Description=Mount storage drive to /mnt/storage0
      Before=local-fs.target
      [Mount]
      What=/dev/disk/by-partlabel/STORAGE0
      Where=/mnt/storage0
      Type=ext4
      Options=defaults,discard,noatime
      [Install]
      WantedBy=local-fs.target

  - name: mnt-storage1.mount
    enabled: true
    contents: |
      [Unit]
      Description=Mount storage drive to /mnt/storage1
      Before=local-fs.target
      [Mount]
      What=/dev/disk/by-partlabel/STORAGE1
      Where=/mnt/storage1
      Type=ext4
      Options=defaults
      [Install]
      WantedBy=local-fs.target
