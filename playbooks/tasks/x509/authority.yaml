# generates a self-signed certificate authority and its matching private key
# run this on localhost

- name: include boilerplate tasks
  include: boilerplate.yaml

- name: create signing key
  openssl_privatekey:
    path: "{{ private_key_directory }}/{{ purpose }}.key"

- name: create self-signing request
  openssl_csr:
    path: "{{ certificate_directory }}/{{ purpose }}.csr"
    privatekey_path: "{{ private_key_directory }}/{{ purpose }}.key"
    organization_name: corebernetes
    common_name: "{{ purpose }}:authority"
    basic_constraints: CA:true
    basic_constraints_critical: true
    key_usage: keyCertSign, cRLSign
    key_usage_critical: true

- name: self-sign certificate authority
  openssl_certificate:
    path: "{{ certificate_directory }}/{{ purpose }}.crt"
    csr_path: "{{ certificate_directory }}/{{ purpose }}.csr"
    privatekey_path: "{{ private_key_directory }}/{{ purpose }}.key"
    provider: selfsigned
